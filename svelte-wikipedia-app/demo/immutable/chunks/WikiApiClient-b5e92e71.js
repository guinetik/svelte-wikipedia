import{d as u,w as d}from"./index-f15d94d8.js";const h="/vanguard-js/svelte-wikipedia-app";function w(e){return e!=="/"?h+"/"+e:h}function f(e){const a=new Date;return a.setDate(e.getDate()-1),a.setHours(0),a}function _(e){const a=new Date;return a.setDate(e.getDate()+1),a.setHours(0),a}let p=d([]),g=d({});Array.prototype.forEachAsyncParallel=async function(e){await Promise.all(this.map(e))};const t={language:"en",SEARCH_BASE_URL:"https://:lang.wikipedia.org/w/api.php",FEATURED_BASE_URL:"https://wikimedia.org/api/rest_v1/metrics/pageviews/top/:lang.wikipedia.org/all-access/:date",searchApiUrl:"",SEARCH_REQUEST_OPTIONS:{format:"json",action:"query",generator:"search",gsrnamespace:0,gsrlimit:10,prop:"pageimages|extracts|pageterms|images|info|extracts&inprop=url",pilimit:"max",exintro:"",explaintext:"",exsentences:1,exlimit:"max",origin:"*",pithumbsize:500},banned:["Wikipedia:Portada","Main_Page","Special:Search","Wikip\xE9dia:P\xE1gina_principal","Especial:Pesquisar","Wikipedia:Featured_pictures","Wikip\xE9dia:Accueil_principal","Portal:Current_events","Wikipedia:Hauptseite","Pagina_principale","Help:IPA/English","CEO","Video_hosting_service","F5_Networks","File:","Ficheiro:","Help","Ajuda"],featuredDate:new Date,searchResults:u(p,e=>{let a=[];if(console.log("new search results:",e),e.query){let i=0;Object.entries(e.query.pages).forEach(l=>{const[n,s]=l,r={i,title:s.title,text:s.extract?s.extract:"",tags:s.terms.alias?s.terms.alias:[],link:s.canonicalurl,image:s.thumbnail?s.thumbnail.source:""};a.push(r),i++})}return a}),featuredArticles:u(g,e=>e),search:e=>{console.log("searching for ",e),t.searchApiUrl=t.getSearchApiUrl(e),t.fetch(t.searchApiUrl,p)},getFeaturedPosts:async e=>{function a(){t.getFeaturedPosts(f(e))}let i=t.FEATURED_BASE_URL.replaceAll(":lang",t.language).replaceAll(":date",e.toJSON().slice(0,10).replaceAll("-","/"));fetch(i).catch(l=>{console.log("API ERROR",l),a()}).then((l,n)=>l.status==200?l.json():null).then(async l=>l?t.parseFeatured(l,e):a())},parseFeatured:async(e,a)=>{g.set([]);const i=[];if(e.items&&e.items.length>0){const l=e.items[0].articles;if(l){let n=1;await l.filter(s=>!t.banned.includes(s.article)).slice(0,50).forEachAsyncParallel(async s=>{const r=await t.getPageDetails(s.article);if(!r.title.toLowerCase().includes("not found")){let c=r.thumbnail?r.thumbnail.source:null;if(c&&c.includes("px-")){const o=c;c=o.split("/").splice(0,o.split("/").length-1).join("/")+"/400px"+o.split("/").pop().slice(o.split("/").pop().indexOf("px")+2)}let A={i:n,title:r.title,tags:["{} views".replace("{}",s.views.toLocaleString())],link:r.content_urls?r.content_urls.desktop.page:"/",image:c,views:s.views,text:r.extract||r.description};i.push(A)}n++})}}t.featuredDate=a,g.set({data:i,featuredDate:a})},getPageDetails:async e=>{let a="https://:lang.wikipedia.org/api/rest_v1/page/summary/:page?origin=*".replaceAll(":lang",t.language).replaceAll(":page",e);return await(await fetch(a)).json()},fetch:(e,a)=>{console.log("fecthing from:",e),fetch(e).then(i=>i.json()).then(i=>{a.set(i)}).catch(i=>(console.log(i),[]))},getSearchApiUrl:e=>{const a="?gsrsearch="+e+Object.entries(t.SEARCH_REQUEST_OPTIONS).reduce((i,l)=>{const[n,s]=l;return i+"&"+n+"="+s},"");return t.getApiBaseURL()+a},getApiBaseURL:()=>(console.log("language",t.language),t.SEARCH_BASE_URL.replaceAll(":lang",t.language)),setLanguage:e=>{const a=t.getApiBaseURL();t.language=e;const i=t.getApiBaseURL();t.searchApiUrl&&(t.searchApiUrl=t.searchApiUrl.replaceAll(a,i),t.fetch(t.searchApiUrl,p)),t.getFeaturedPosts(t.featuredDate)}};export{t as W,_ as a,f as b,w as g};
