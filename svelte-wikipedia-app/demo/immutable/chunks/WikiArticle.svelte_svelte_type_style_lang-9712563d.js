var x=Object.defineProperty,_=Object.defineProperties;var k=Object.getOwnPropertyDescriptors;var f=Object.getOwnPropertySymbols;var y=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable;var A=(t,i,a)=>i in t?x(t,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[i]=a,n=(t,i)=>{for(var a in i||(i={}))y.call(i,a)&&A(t,a,i[a]);if(f)for(var a of f(i))E.call(i,a)&&A(t,a,i[a]);return t},c=(t,i)=>_(t,k(i));import{w as h,d as m}from"./singletons-e01e0108.js";import{b as U}from"./index-bb7c7d40.js";let u=h([]),d=h({});Array.prototype.forEachAsyncParallel=async function(t){await Promise.all(this.map(t))};const e={language:"en",SEARCH_BASE_URL:"https://:lang.wikipedia.org/w/api.php",FEATURED_BASE_URL:"https://wikimedia.org/api/rest_v1/metrics/pageviews/top/:lang.wikipedia.org/all-access/:date",searchApiUrl:null,SEARCH_REQUEST_OPTIONS:{format:"json",action:"query",generator:"search",gsrnamespace:0,gsrlimit:10,prop:"pageimages|extracts|pageterms|images|info|extracts&inprop=url",pilimit:"max",exintro:"",explaintext:"",exsentences:1,exlimit:"max",origin:"*",pithumbsize:500},banned:["Wikipedia:Portada","Main_Page","Special:Search","Wikip\xE9dia:P\xE1gina_principal","Especial:Pesquisar","Wikipedia:Featured_pictures","Wikip\xE9dia:Accueil_principal","Portal:Current_events","Wikipedia:Hauptseite","Pagina_principale","Help:IPA/English","CEO","Video_hosting_service","F5_Networks","File:","Ficheiro:","Help","Ajuda"],featuredDate:new Date,state:h({loading:!1}),searchResults:m(u,t=>{let i=[];if(console.log("new search results:",t),t.query){let a=0;Object.entries(t.query.pages).forEach(l=>{const[o,s]=l,r={i:a,title:s.title,text:s.extract?s.extract:"",tags:s.terms.alias?s.terms.alias:[],link:s.canonicalurl,image:s.thumbnail?s.thumbnail.source:""};i.push(r),a++})}return i}),featuredArticles:m(d,t=>t),search:t=>{console.log("searching for ",t),e.searchApiUrl=e.getSearchApiUrl(t),e.fetch(e.searchApiUrl,u)},getFeaturedPosts:async t=>{function i(){e.getFeaturedPosts(U(t))}let a=e.FEATURED_BASE_URL.replaceAll(":lang",e.language).replaceAll(":date",t.toJSON().slice(0,10).replaceAll("-","/"));e.state.set(c(n({},e.state),{loading:!0})),fetch(a).catch(l=>{e.state.set(c(n({},e.state),{loading:!1})),console.log("API ERROR",l),i()}).then((l,o)=>(e.state.set(c(n({},e.state),{loading:!1})),l.status==200?l.json():null)).then(async l=>l?e.parseFeatured(l,t):i())},parseFeatured:async(t,i)=>{d.set([]);const a=[];if(t.items&&t.items.length>0){const l=t.items[0].articles;if(l){let o=1;await l.filter(s=>!e.banned.includes(s.article)).slice(0,50).forEachAsyncParallel(async s=>{const r=await e.getPageDetails(s.article);if(!r.title.toLowerCase().includes("not found")){let p=r.thumbnail?r.thumbnail.source:null;if(p&&p.includes("px-")){const g=p;p=g.split("/").splice(0,g.split("/").length-1).join("/")+"/400px"+g.split("/").pop().slice(g.split("/").pop().indexOf("px")+2)}let w={i:o,title:r.title,tags:["{} views".replace("{}",s.views.toLocaleString())],link:r.content_urls?r.content_urls.desktop.page:"/",image:p,views:s.views,text:r.extract||r.description};a.push(w)}o++})}}e.featuredDate=i,d.set({data:a,featuredDate:i})},getPageDetails:async t=>{let i="https://:lang.wikipedia.org/api/rest_v1/page/summary/:page?origin=*".replaceAll(":lang",e.language).replaceAll(":page",t);e.state.set(c(n({},e.state),{loading:!0}));const a=await fetch(i);return e.state.set(c(n({},e.state),{loading:!1})),await a.json()},fetch:(t,i)=>{console.log("fecthing from:",t),e.state.set(c(n({},e.state),{loading:!0})),fetch(t).then(a=>a.json()).then(a=>{i.set(a),e.state.set(c(n({},e.state),{loading:!1}))}).catch(a=>(console.log(a),e.state.set(c(n({},e.state),{loading:!1})),[]))},getSearchApiUrl:t=>{const i="?gsrsearch="+t+Object.entries(e.SEARCH_REQUEST_OPTIONS).reduce((a,l)=>{const[o,s]=l;return a+"&"+o+"="+s},"");return e.getApiBaseURL()+i},getApiBaseURL:()=>(console.log("language",e.language),e.SEARCH_BASE_URL.replaceAll(":lang",e.language)),setLanguage:t=>{const i=e.getApiBaseURL();e.language=t;const a=e.getApiBaseURL();e.searchApiUrl&&(e.searchApiUrl=e.searchApiUrl.replaceAll(i,a),e.fetch(e.searchApiUrl,u)),e.getFeaturedPosts(e.featuredDate)}};export{e as W,u as s};
