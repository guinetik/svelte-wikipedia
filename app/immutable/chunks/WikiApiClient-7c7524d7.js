var R=Object.defineProperty,_=Object.defineProperties;var U=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var w=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable;var f=(t,i,a)=>i in t?R(t,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[i]=a,n=(t,i)=>{for(var a in i||(i={}))w.call(i,a)&&f(t,a,i[a]);if(A)for(var a of A(i))x.call(i,a)&&f(t,a,i[a]);return t},c=(t,i)=>_(t,U(i));import{w as h,d as m}from"./singletons-4df41ad8.js";import{b as S}from"./utils-d0e190a7.js";let u=h([]),d=h({});Array.prototype.forEachAsyncParallel=async function(t){await Promise.all(this.map(t))};const e={retries:0,maxRetries:10,language:"en",SEARCH_BASE_URL:"https://:lang.wikipedia.org/w/api.php",FEATURED_BASE_URL:"https://wikimedia.org/api/rest_v1/metrics/pageviews/top/:lang.wikipedia.org/all-access/:date",searchApiUrl:null,SEARCH_REQUEST_OPTIONS:{format:"json",action:"query",generator:"search",gsrnamespace:0,gsrlimit:10,prop:"pageimages|extracts|pageterms|images|info|extracts&inprop=url",pilimit:"max",exintro:"",explaintext:"",exsentences:1,exlimit:"max",origin:"*",pithumbsize:500},banned:["Wikipedia:Portada","Main_Page","Special:Search","Wikip\xE9dia:P\xE1gina_principal","Especial:Pesquisar","Wikipedia:Featured_pictures","Wikip\xE9dia:Accueil_principal","Portal:Current_events","Wikipedia:Hauptseite","Pagina_principale","Help:IPA/English","CEO","Video_hosting_service","F5_Networks","File:","Ficheiro:","Help","Ajuda"],featuredDate:new Date,state:h({loading:!1}),searchResults:m(u,t=>{let i=[];if(t.query){let a=0;Object.entries(t.query.pages).forEach(s=>{const[p,r]=s,l={i:a,title:r.title,text:r.extract?r.extract:"",tags:r.terms.alias?r.terms.alias:[],link:r.canonicalurl,image:r.thumbnail?r.thumbnail.source:""};i.push(l),a++})}return i}),featuredArticles:m(d,t=>t),search:t=>{e.searchApiUrl=e.getSearchApiUrl(t),e.fetch(e.searchApiUrl,u)},getFeaturedPosts:async t=>{function i(){e.retries<e.maxRetries?(setTimeout(e.getFeaturedPosts,1e3*e.retries+1,S(t)),e.retries++):console.warn("MAX RETRIES REACHED! GIVING UP!")}let a=e.FEATURED_BASE_URL.replaceAll(":lang",e.language).replaceAll(":date",t.toJSON().slice(0,10).replaceAll("-","/"));e.state.set(c(n({},e.state),{loading:!0})),fetch(a).catch(s=>{e.state.set(c(n({},e.state),{loading:!1})),console.error("API ERROR",s)}).then((s,p)=>(e.state.set(c(n({},e.state),{loading:!1})),s&&s.status==200?s.json():null)).then(async s=>s?e.parseFeatured(s,t):i())},parseFeatured:async(t,i)=>{d.set([]);const a=[];if(t.items&&t.items.length>0){const s=t.items[0].articles;if(s){let p=1;await s.filter(r=>!e.banned.includes(r.article)).slice(0,50).forEachAsyncParallel(async r=>{const l=await e.getPageDetails(r.article);if(!l.title.toLowerCase().includes("not found")){let o=l.thumbnail?l.thumbnail.source:null;if(o&&o.includes("px-")){const g=o;o=g.split("/").splice(0,g.split("/").length-1).join("/")+"/400px"+g.split("/").pop().slice(g.split("/").pop().indexOf("px")+2)}let E={i:p,title:l.title,tags:["{} views".replace("{}",r.views.toLocaleString())],link:l.content_urls?l.content_urls.desktop.page:"/",image:o,views:r.views,text:l.extract||l.description};a.push(E)}p++})}}e.featuredDate=i,d.set({data:a,featuredDate:i})},getPageDetails:async t=>{let i="https://:lang.wikipedia.org/api/rest_v1/page/summary/:page?origin=*".replaceAll(":lang",e.language).replaceAll(":page",t);e.state.set(c(n({},e.state),{loading:!0}));const a=await fetch(i);return e.state.set(c(n({},e.state),{loading:!1})),await a.json()},fetch:(t,i)=>{e.state.set(c(n({},e.state),{loading:!0})),fetch(t).then(a=>a.json()).then(a=>{i.set(a),e.state.set(c(n({},e.state),{loading:!1}))}).catch(a=>(e.state.set(c(n({},e.state),{loading:!1})),[]))},getSearchApiUrl:t=>{const i="?gsrsearch="+t+Object.entries(e.SEARCH_REQUEST_OPTIONS).reduce((a,s)=>{const[p,r]=s;return a+"&"+p+"="+r},"");return e.getApiBaseURL()+i},getApiBaseURL:()=>e.SEARCH_BASE_URL.replaceAll(":lang",e.language),setLanguage:t=>{const i=e.getApiBaseURL();e.language=t;const a=e.getApiBaseURL();e.searchApiUrl&&(e.searchApiUrl=e.searchApiUrl.replaceAll(i,a),e.fetch(e.searchApiUrl,u)),e.getFeaturedPosts(e.featuredDate)}};export{e as W,u as s};
