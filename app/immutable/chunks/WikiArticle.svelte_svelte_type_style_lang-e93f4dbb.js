var w=Object.defineProperty,_=Object.defineProperties;var E=Object.getOwnPropertyDescriptors;var f=Object.getOwnPropertySymbols;var R=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var A=(t,i,a)=>i in t?w(t,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[i]=a,n=(t,i)=>{for(var a in i||(i={}))R.call(i,a)&&A(t,a,i[a]);if(f)for(var a of f(i))U.call(i,a)&&A(t,a,i[a]);return t},o=(t,i)=>_(t,E(i));import{w as h,d as m}from"./singletons-e01e0108.js";import{b as k}from"./index-1ae2aa9e.js";let u=h([]),d=h({});Array.prototype.forEachAsyncParallel=async function(t){await Promise.all(this.map(t))};const e={retries:0,maxRetries:10,language:"en",SEARCH_BASE_URL:"https://:lang.wikipedia.org/w/api.php",FEATURED_BASE_URL:"https://wikimedia.org/api/rest_v1/metrics/pageviews/top/:lang.wikipedia.org/all-access/:date",searchApiUrl:null,SEARCH_REQUEST_OPTIONS:{format:"json",action:"query",generator:"search",gsrnamespace:0,gsrlimit:10,prop:"pageimages|extracts|pageterms|images|info|extracts&inprop=url",pilimit:"max",exintro:"",explaintext:"",exsentences:1,exlimit:"max",origin:"*",pithumbsize:500},banned:["Wikipedia:Portada","Main_Page","Special:Search","Wikip\xE9dia:P\xE1gina_principal","Especial:Pesquisar","Wikipedia:Featured_pictures","Wikip\xE9dia:Accueil_principal","Portal:Current_events","Wikipedia:Hauptseite","Pagina_principale","Help:IPA/English","CEO","Video_hosting_service","F5_Networks","File:","Ficheiro:","Help","Ajuda"],featuredDate:new Date,state:h({loading:!1}),searchResults:m(u,t=>{let i=[];if(console.log("new search results:",t),t.query){let a=0;Object.entries(t.query.pages).forEach(s=>{const[c,l]=s,r={i:a,title:l.title,text:l.extract?l.extract:"",tags:l.terms.alias?l.terms.alias:[],link:l.canonicalurl,image:l.thumbnail?l.thumbnail.source:""};i.push(r),a++})}return i}),featuredArticles:m(d,t=>t),search:t=>{console.log("searching for ",t),e.searchApiUrl=e.getSearchApiUrl(t),e.fetch(e.searchApiUrl,u)},getFeaturedPosts:async t=>{function i(){e.retries<e.maxRetries?(setTimeout(e.getFeaturedPosts,1e3*e.retries+1,k(t)),e.retries++):console.warn("MAX RETRIES REACHED! GIVING UP!")}let a=e.FEATURED_BASE_URL.replaceAll(":lang",e.language).replaceAll(":date",t.toJSON().slice(0,10).replaceAll("-","/"));e.state.set(o(n({},e.state),{loading:!0})),fetch(a).catch(s=>{e.state.set(o(n({},e.state),{loading:!1})),console.log("API ERROR",s)}).then((s,c)=>(console.log("aaaa",c),e.state.set(o(n({},e.state),{loading:!1})),s&&s.status==200?s.json():null)).then(async s=>s?e.parseFeatured(s,t):i())},parseFeatured:async(t,i)=>{d.set([]);const a=[];if(t.items&&t.items.length>0){const s=t.items[0].articles;if(s){let c=1;await s.filter(l=>!e.banned.includes(l.article)).slice(0,50).forEachAsyncParallel(async l=>{const r=await e.getPageDetails(l.article);if(!r.title.toLowerCase().includes("not found")){let p=r.thumbnail?r.thumbnail.source:null;if(p&&p.includes("px-")){const g=p;p=g.split("/").splice(0,g.split("/").length-1).join("/")+"/400px"+g.split("/").pop().slice(g.split("/").pop().indexOf("px")+2)}let x={i:c,title:r.title,tags:["{} views".replace("{}",l.views.toLocaleString())],link:r.content_urls?r.content_urls.desktop.page:"/",image:p,views:l.views,text:r.extract||r.description};a.push(x)}c++})}}e.featuredDate=i,d.set({data:a,featuredDate:i})},getPageDetails:async t=>{let i="https://:lang.wikipedia.org/api/rest_v1/page/summary/:page?origin=*".replaceAll(":lang",e.language).replaceAll(":page",t);e.state.set(o(n({},e.state),{loading:!0}));const a=await fetch(i);return e.state.set(o(n({},e.state),{loading:!1})),await a.json()},fetch:(t,i)=>{console.log("fecthing from:",t),e.state.set(o(n({},e.state),{loading:!0})),fetch(t).then(a=>a.json()).then(a=>{i.set(a),e.state.set(o(n({},e.state),{loading:!1}))}).catch(a=>(console.log(a),e.state.set(o(n({},e.state),{loading:!1})),[]))},getSearchApiUrl:t=>{const i="?gsrsearch="+t+Object.entries(e.SEARCH_REQUEST_OPTIONS).reduce((a,s)=>{const[c,l]=s;return a+"&"+c+"="+l},"");return e.getApiBaseURL()+i},getApiBaseURL:()=>(console.log("language",e.language),e.SEARCH_BASE_URL.replaceAll(":lang",e.language)),setLanguage:t=>{const i=e.getApiBaseURL();e.language=t;const a=e.getApiBaseURL();e.searchApiUrl&&(e.searchApiUrl=e.searchApiUrl.replaceAll(i,a),e.fetch(e.searchApiUrl,u)),e.getFeaturedPosts(e.featuredDate)}};export{e as W,u as s};
